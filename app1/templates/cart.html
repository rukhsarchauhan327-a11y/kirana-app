<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cart - Kirana Konnect</title>
    <script src="/static/js/tailwind.js"></script>
    <script> window.FontAwesomeConfig = { autoReplaceSvg: 'nest'};</script>
    <link rel="stylesheet" href="/static/css/fontawesome.min.css">
    <style>::-webkit-scrollbar { display: none;}</style>
    
    <script>tailwind.config = {
  "theme": {
    "extend": {
      "colors": {
        "primary": "#4CAF50",
        "secondary": "#2196F3",
        "accent": "#FF9800",
        "danger": "#F44336",
        "dark": "#333333",
        "light": "#F5F5F5"
      },
      "fontFamily": {
        "poppins": [
          "Poppins",
          "sans-serif"
        ],
        "sans": [
          "Inter",
          "sans-serif"
        ]
      }
    }
  }
};</script>


<link rel="stylesheet" href="/static/css/fonts.css">
<style>
      body {
        font-family: 'Inter', sans-serif !important;
      }
      
      /* Preserve Font Awesome icons */
      .fa, .fas, .far, .fal, .fab {
        font-family: "Font Awesome 6 Free", "Font Awesome 6 Brands" !important;
      }
      
      .edit-button {
        position: absolute;
        z-index: 1000;
        top: 8px;
        right: 40px;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 4px 8px;
        font-size: 11px;
        color: #4CAF50;
        cursor: pointer;
        transition: all 0.2s;
      }
      
      .edit-button:hover {
        background: #4CAF50;
        color: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
    </style>
    <style>
      ::-webkit-scrollbar {
        display: none;
      }

      html, body {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
    </style>
</head>
<body class="font-poppins bg-gray-50">
    <!-- Header Section -->
    <header id="header" class="bg-white shadow-sm fixed top-0 left-0 right-0 z-20">
        <div class="flex items-center justify-between p-4">
            <button class="p-2 rounded-full hover:bg-gray-100" onclick="goBack()">
                <i class="fa-solid fa-arrow-left text-dark text-lg"></i>
            </button>
            <h1 class="text-lg font-bold text-dark">Cart</h1>
            <div class="w-10"></div>
        </div>
    </header>

    <!-- Shop Info Section -->
    <div id="shop-info" class="bg-white shadow-sm mt-16 p-3 border-b">
        <div class="text-center">
            <h2 class="text-base font-bold text-dark">Kirana Konnect</h2>
            <h3 class="text-sm font-semibold text-dark mt-1">Sharma Kirana Store</h3>
            <p class="text-xs text-gray-600 mt-1">GST: 24ABCDE1234F1Z5</p>
            <p class="text-xs text-gray-600">UDYAM: UDYAM-UP-12-0012345</p>
        </div>
    </div>

    <!-- Bill Type Selection -->
    <div id="bill-type-section" class="px-4 py-3">
        <div class="bg-white rounded-xl shadow-sm p-3">
            <div class="flex justify-center">
                <div class="flex bg-gray-100 rounded-full p-1 w-full max-w-md">
                    <button id="billing-tab" class="flex-1 py-2 px-2 rounded-full bg-primary text-white font-medium text-xs text-center" onclick="showBillingTab()">
                        Billing
                    </button>
                    <button id="customer-tab" class="flex-1 py-2 px-2 rounded-full text-gray-600 font-medium text-xs text-center" onclick="showCustomerTab()">
                        Customer
                    </button>
                    <button id="new-customer-tab" class="flex-1 py-2 px-2 rounded-full text-gray-600 font-medium text-xs text-center" onclick="showNewCustomerTab()">
                        New Customer
                    </button>
                </div>
            </div>
            
            <!-- Bill Number Section -->
            <div id="bill-section" class="mt-3">
                <div class="text-center mb-3">
                    <p class="text-xs text-gray-600">Bill No:</p>
                    <p class="text-lg font-bold text-primary">#KK-2025-001</p>
                </div>
                <div class="border-t pt-3">
                    <p class="text-xs text-gray-600 mb-2">Add name to bill (optional):</p>
                    <input type="text" id="bill-customer-name" placeholder="Enter customer name for bill" class="w-full p-2 border border-gray-200 rounded-lg text-sm">
                </div>
            </div>

            <!-- Customer Search Section -->
            <div id="customer-section" class="mt-3 hidden">
                <div class="relative">
                    <input type="text" placeholder="Search customer..." class="w-full p-2 border border-gray-200 rounded-lg pr-10 text-sm" onclick="openSearch()">
                    <i class="fa-solid fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>
                <div class="mt-2 space-y-2">
                    <div class="p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100" onclick="selectCustomer('Rajesh Kumar')">
                        <p class="font-medium text-dark text-sm">Rajesh Kumar</p>
                        <p class="text-xs text-gray-600">+91 9876543210</p>
                    </div>
                    <div class="p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100" onclick="selectCustomer('Priya Sharma')">
                        <p class="font-medium text-dark text-sm">Priya Sharma</p>
                        <p class="text-xs text-gray-600">+91 9876543211</p>
                    </div>
                </div>
            </div>

            <!-- New Customer Section -->
            <div id="new-customer-section" class="mt-3 hidden">
                <div class="space-y-2">
                    <input type="text" id="new-customer-name" placeholder="Customer Name" class="w-full p-2 border border-gray-200 rounded-lg text-sm">
                    <input type="tel" id="new-customer-phone" placeholder="Contact Number" class="w-full p-2 border border-gray-200 rounded-lg text-sm">
                    <button class="w-full bg-primary text-white py-2 rounded-lg font-medium text-sm" onclick="saveNewCustomer()">Save Customer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cart Items List -->
    <div id="cart-items" class="px-4 space-y-2 mb-4">
        <!-- Cart items will be rendered here dynamically -->
    </div>

    <!-- Add More Items Section -->
    <div id="add-items-section" class="px-4 mb-3">
        <div class="bg-white rounded-xl shadow-sm p-3">
            <div class="flex justify-center">
                <button id="add-items-btn" class="flex items-center justify-center bg-secondary text-white rounded-full px-6 py-3 font-medium text-sm hover:bg-blue-600 transition-colors" onclick="addMoreItems()">
                    <i class="fa-solid fa-plus mr-2"></i>
                    Add More Items to Cart
                </button>
            </div>
        </div>
    </div>

    <!-- Tax & Offer Section -->
    <div id="tax-offer-section" class="px-4 mb-3">
        <div class="bg-white rounded-xl shadow-sm p-3">
            <div class="grid grid-cols-2 gap-3">
                <button id="tax-btn" class="p-3 border-2 border-primary bg-primary/10 rounded-xl text-center" onclick="toggleTax()">
                    <i class="fa-solid fa-percentage text-primary text-lg mb-1"></i>
                    <p class="text-xs font-medium text-primary">Add Tax</p>
                </button>
                <button id="offer-btn" class="p-3 border-2 border-gray-200 rounded-xl text-center hover:border-accent hover:bg-accent/10" onclick="toggleOffer()">
                    <i class="fa-solid fa-tag text-gray-600 text-lg mb-1"></i>
                    <p class="text-xs font-medium text-gray-600">Add Offer</p>
                </button>
            </div>
            
            <!-- Tax Section -->
            <div id="tax-section" class="mt-3">
                <div class="space-y-1">
                    <div class="flex justify-between">
                        <span class="text-gray-600 text-sm">Subtotal</span>
                        <span class="font-medium text-sm" id="subtotal">₹955</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 text-sm">GST (18%)</span>
                        <span class="font-medium text-sm" id="gst">₹171.90</span>
                    </div>
                </div>
            </div>

            <!-- Offer Section -->
            <div id="offer-section" class="mt-3 hidden">
                <div class="grid grid-cols-2 gap-2">
                    <input type="number" placeholder="Discount ₹" class="p-2 border border-gray-200 rounded-lg text-sm" onchange="calculateDiscount()">
                    <input type="number" placeholder="Discount %" class="p-2 border border-gray-200 rounded-lg text-sm" onchange="calculateDiscount()">
                </div>
            </div>
        </div>
    </div>

    <!-- Total Amount -->
    <div id="total-section" class="px-4 mb-3">
        <div class="bg-white rounded-xl shadow-sm p-3">
            <div class="flex justify-between items-center">
                <span class="text-lg font-bold text-dark">Total Amount</span>
                <span class="text-xl font-bold text-primary" id="total">₹1,126.90</span>
            </div>
        </div>
    </div>

    <!-- Bill Generated By -->
    <div id="generated-by-section" class="px-4 mb-3">
        <div class="bg-white rounded-xl shadow-sm p-3">
            <div class="flex items-center justify-between">
                <span class="text-gray-600 font-medium text-sm">Bill Generated By:</span>
                <select id="bill-generator" class="p-2 border border-gray-200 rounded-lg bg-white text-sm min-w-0 flex-1 ml-2">
                    <option>Anil Kumar (Cashier)</option>
                    <option>Rajesh Sharma (Owner)</option>
                    <option>Priya Singh (Manager)</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Payment Method -->
    <div id="payment-section" class="px-4 mb-3">
        <div class="bg-white rounded-xl shadow-sm p-3">
            <div class="flex justify-center mb-3">
                <div class="flex bg-gray-100 rounded-full p-1 w-full max-w-xs">
                    <button id="cash-payment" class="flex-1 py-2 px-2 rounded-full bg-primary text-white font-medium text-xs" onclick="selectPayment('cash')">
                        Cash
                    </button>
                    <button id="online-payment" class="flex-1 py-2 px-2 rounded-full text-gray-600 font-medium text-xs" onclick="selectPayment('online')">
                        Online
                    </button>
                    <button id="split-payment" class="flex-1 py-2 px-2 rounded-full text-gray-600 font-medium text-xs" onclick="selectPayment('split')">
                        Split
                    </button>
                </div>
            </div>

            <!-- Online Payment Section -->
            <div id="online-payment-section" class="hidden">
                <div class="space-y-2">
                    <div class="grid grid-cols-2 gap-2">
                        <button class="p-2 border border-gray-200 rounded-lg text-sm bg-blue-50 text-blue-600">UPI</button>
                        <button class="p-2 border border-gray-200 rounded-lg text-sm bg-green-50 text-green-600">Card</button>
                    </div>
                    <input type="text" placeholder="UPI ID or Transaction Reference" class="w-full p-2 border border-gray-200 rounded-lg text-sm">
                </div>
            </div>

            <!-- Split Payment Section -->
            <div id="split-payment-section" class="hidden">
                <div class="space-y-2">
                    <div class="flex items-center space-x-2">
                        <input type="number" id="split-amount" placeholder="Enter amount" class="flex-1 p-2 border border-gray-200 rounded-lg text-sm">
                        <button id="apply-split" class="bg-primary text-white px-3 py-2 rounded-lg text-xs font-medium" onclick="applySplit()">Apply</button>
                    </div>
                    <div id="remaining-amount" class="hidden">
                        <p class="text-sm text-gray-600 mb-2">Remaining: <span id="remaining-value" class="font-bold">₹0</span></p>
                        <div class="grid grid-cols-3 gap-2">
                            <button id="remaining-cash" class="py-2 px-3 border border-gray-300 rounded-lg text-xs" onclick="selectRemaining('cash')">Cash</button>
                            <button id="remaining-online" class="py-2 px-3 border border-gray-300 rounded-lg text-xs" onclick="selectRemaining('online')">Online</button>
                            <button id="remaining-credit" class="py-2 px-3 border border-gray-300 rounded-lg text-xs" onclick="selectRemaining('credit')">Credit</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Generate Bill Button -->
    <div id="generate-bill-section" class="px-4 pb-24">
        <button class="w-full bg-primary text-white py-3 rounded-xl font-bold text-base shadow-md" onclick="generateBill()">
            Generate Bill
        </button>
    </div>

    <!-- Edit Item Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center px-4">
        <div class="bg-white rounded-xl p-4 w-full max-w-sm">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-base font-bold text-dark">Edit Item</h3>
                <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700 p-1">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-3">
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Item</label>
                    <input type="text" id="edit-item-name" class="w-full p-2 border border-gray-200 rounded-lg text-sm bg-gray-50" readonly>
                </div>
                
                <div class="grid grid-cols-3 gap-2">
                    <div class="col-span-2">
                        <label class="block text-xs font-medium text-gray-700 mb-1">Quantity</label>
                        <input type="number" id="edit-item-quantity" class="w-full p-2 border border-gray-200 rounded-lg text-sm" step="0.001">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Unit</label>
                        <input type="text" id="edit-item-unit" class="w-full p-2 border border-gray-200 rounded-lg text-sm">
                    </div>
                </div>
                
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Price (₹)</label>
                    <input type="number" id="edit-item-price" class="w-full p-2 border border-gray-200 rounded-lg text-sm" step="0.01">
                </div>
                
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">MFG Date</label>
                        <input type="date" id="edit-item-mfg" class="w-full p-2 border border-gray-200 rounded-lg text-xs">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">EXP Date</label>
                        <input type="date" id="edit-item-exp" class="w-full p-2 border border-gray-200 rounded-lg text-xs">
                    </div>
                </div>
                
                <div class="flex space-x-2 pt-2">
                    <button onclick="closeEditModal()" class="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg text-sm font-medium">
                        Cancel
                    </button>
                    <button onclick="saveEditedItem()" class="flex-1 bg-primary text-white py-2 rounded-lg text-sm font-medium">
                        Save
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Cart items storage
        let cartItems = [
            {
                id: 1,
                name: 'Aashirvaad Atta',
                quantity: 10,
                unit: 'Kg',
                price: 450,
                mfgDate: '01/05/2025',
                expDate: '01/09/2025',
                showDates: true
            },
            {
                id: 2,
                name: 'Real Fruit Juice',
                quantity: 2,
                unit: 'Bottles',
                price: 120,
                mfgDate: '12/05/2025',
                expDate: '25/07/2025',
                showDates: true
            },
            {
                id: 3,
                name: 'Colgate Paste',
                quantity: 3,
                unit: 'Pieces',
                price: 90,
                showDates: false
            },
            {
                id: 4,
                name: 'Good Day Biscuits',
                quantity: 5,
                unit: 'Packets',
                price: 60,
                mfgDate: '10/04/2025',
                expDate: '10/08/2025',
                showDates: true
            },
            {
                id: 5,
                name: 'Surf Excel (500gm)',
                quantity: 1,
                unit: 'Packet',
                price: 55,
                showDates: false
            },
            {
                id: 6,
                name: 'Dabur Honey',
                quantity: 1,
                unit: 'Bottle',
                price: 180,
                mfgDate: '05/03/2025',
                expDate: '05/01/2026',
                showDates: true
            }
        ];

        let currentTab = 'billing';
        let taxEnabled = true;
        let offerEnabled = false;
        let editingItemIndex = -1;

        // Load cart from localStorage
        function loadCart() {
            try {
                const saved = localStorage.getItem('kiranakonnect_persistent_cart');
                if (saved) {
                    const items = JSON.parse(saved);
                    if (items.length > 0) {
                        cartItems = items;
                    }
                }
            } catch (error) {
                console.error('Error loading cart:', error);
            }
        }

        // Save cart to localStorage
        function saveCart() {
            try {
                localStorage.setItem('kiranakonnect_persistent_cart', JSON.stringify(cartItems));
            } catch (error) {
                console.error('Error saving cart:', error);
            }
        }

        // Check for new items from inventory
        function checkNewItems() {
            try {
                const newItems = localStorage.getItem('kiranakonnect_cart');
                if (newItems) {
                    const items = JSON.parse(newItems);
                    if (items.length > 0) {
                        items.forEach(item => {
                            cartItems.push({
                                id: Date.now() + Math.random(),
                                name: item.name,
                                quantity: item.quantity || 1,
                                unit: item.unit || 'Piece',
                                price: parseFloat(item.price || item.totalPrice || 0),
                                mfgDate: item.mfgDate || '',
                                expDate: item.expDate || '',
                                showDates: !!(item.mfgDate && item.expDate)
                            });
                        });
                        localStorage.removeItem('kiranakonnect_cart');
                        saveCart();
                        renderCart();
                    }
                }
            } catch (error) {
                console.error('Error processing new items:', error);
                localStorage.removeItem('kiranakonnect_cart');
            }
        }

        // Render cart items
        function renderCart() {
            const container = document.getElementById('cart-items');
            container.innerHTML = '';

            cartItems.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'bg-white rounded-xl shadow-sm p-3 relative';
                itemDiv.id = `cart-item-${item.id}`;
                
                let html = `
                    <button class="edit-button" onclick="editItem(${index})">
                        <i class="fa-solid fa-edit mr-1"></i>Edit
                    </button>
                    <div class="flex items-start justify-between">
                        <div class="flex-1 pr-20">
                            <h3 class="font-semibold text-dark text-sm">${item.name}</h3>
                            <div class="flex justify-between items-center mt-1">
                                <span class="text-sm text-gray-700 font-medium">${item.quantity} ${item.unit}</span>
                                <span class="text-lg font-bold text-primary">₹${item.price}</span>
                            </div>
                `;
                
                if (item.showDates && item.mfgDate && item.expDate) {
                    html += `
                            <div class="mt-2 space-y-1">
                                <div class="flex items-center text-xs text-gray-500">
                                    <i class="fa-solid fa-calendar mr-1"></i>
                                    <span>MFG: ${item.mfgDate}</span>
                                </div>
                                <div class="flex items-center text-xs text-gray-500">
                                    <i class="fa-solid fa-clock mr-1"></i>
                                    <span>EXP: ${item.expDate}</span>
                                </div>
                                <button class="text-xs text-danger hover:underline flex items-center mt-1" onclick="removeDates(${index})">
                                    <i class="fa-solid fa-times mr-1"></i>
                                    Remove Dates
                                </button>
                            </div>
                    `;
                }

                html += `
                        </div>
                        <button class="text-danger text-sm ml-3 p-1" onclick="removeItem(${index})">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                `;

                itemDiv.innerHTML = html;
                container.appendChild(itemDiv);
            });

            calculateTotals();
        }

        // Calculate totals
        function calculateTotals() {
            const subtotal = cartItems.reduce((sum, item) => sum + item.price, 0);
            const gst = taxEnabled ? subtotal * 0.18 : 0;
            const total = subtotal + gst;

            document.getElementById('subtotal').textContent = `₹${subtotal.toFixed(2)}`;
            document.getElementById('gst').textContent = `₹${gst.toFixed(2)}`;
            document.getElementById('total').textContent = `₹${total.toFixed(2)}`;
        }

        // Tab functions
        function showBillingTab() {
            currentTab = 'billing';
            updateTabs();
            document.getElementById('bill-section').classList.remove('hidden');
            document.getElementById('customer-section').classList.add('hidden');
            document.getElementById('new-customer-section').classList.add('hidden');
        }

        function showCustomerTab() {
            currentTab = 'customer';
            updateTabs();
            document.getElementById('bill-section').classList.add('hidden');
            document.getElementById('customer-section').classList.remove('hidden');
            document.getElementById('new-customer-section').classList.add('hidden');
        }

        function showNewCustomerTab() {
            currentTab = 'new-customer';
            updateTabs();
            document.getElementById('bill-section').classList.add('hidden');
            document.getElementById('customer-section').classList.add('hidden');
            document.getElementById('new-customer-section').classList.remove('hidden');
        }

        function updateTabs() {
            const tabs = ['billing-tab', 'customer-tab', 'new-customer-tab'];
            tabs.forEach(tab => {
                const element = document.getElementById(tab);
                if (tab === `${currentTab}-tab`) {
                    element.className = 'flex-1 py-2 px-2 rounded-full bg-primary text-white font-medium text-xs text-center';
                } else {
                    element.className = 'flex-1 py-2 px-2 rounded-full text-gray-600 font-medium text-xs text-center';
                }
            });
        }

        // Payment functions
        function selectPayment(type) {
            const buttons = ['cash-payment', 'online-payment', 'split-payment'];
            buttons.forEach(btn => {
                const element = document.getElementById(btn);
                if (btn === `${type}-payment`) {
                    element.className = 'flex-1 py-2 px-2 rounded-full bg-primary text-white font-medium text-xs';
                } else {
                    element.className = 'flex-1 py-2 px-2 rounded-full text-gray-600 font-medium text-xs';
                }
            });

            // Show/hide payment sections
            document.getElementById('online-payment-section').classList.toggle('hidden', type !== 'online');
            document.getElementById('split-payment-section').classList.toggle('hidden', type !== 'split');
        }

        // Tax and offer functions
        function toggleTax() {
            taxEnabled = !taxEnabled;
            const btn = document.getElementById('tax-btn');
            if (taxEnabled) {
                btn.className = 'p-3 border-2 border-primary bg-primary/10 rounded-xl text-center';
            } else {
                btn.className = 'p-3 border-2 border-gray-200 rounded-xl text-center hover:border-primary hover:bg-primary/10';
            }
            calculateTotals();
        }

        function toggleOffer() {
            offerEnabled = !offerEnabled;
            const section = document.getElementById('offer-section');
            section.classList.toggle('hidden', !offerEnabled);
        }

        // Other functions
        function goBack() {
            window.location.href = '/dashboard';
        }

        function addMoreItems() {
            window.location.href = '/inventory';
        }

        function removeItem(index) {
            cartItems.splice(index, 1);
            saveCart();
            renderCart();
        }

        function removeDates(index) {
            cartItems[index].showDates = false;
            saveCart();
            renderCart();
        }

        function selectCustomer(name) {
            alert(`Selected customer: ${name}`);
        }

        function saveNewCustomer() {
            const name = document.getElementById('new-customer-name').value;
            const phone = document.getElementById('new-customer-phone').value;
            if (name && phone) {
                alert(`New customer saved: ${name} (${phone})`);
                document.getElementById('new-customer-name').value = '';
                document.getElementById('new-customer-phone').value = '';
            }
        }

        function applySplit() {
            const amount = document.getElementById('split-amount').value;
            const total = cartItems.reduce((sum, item) => sum + item.price, 0);
            const remaining = total - parseFloat(amount || 0);
            
            document.getElementById('remaining-value').textContent = `₹${remaining.toFixed(2)}`;
            document.getElementById('remaining-amount').classList.remove('hidden');
        }

        function selectRemaining(type) {
            const buttons = ['remaining-cash', 'remaining-online', 'remaining-credit'];
            buttons.forEach(btn => {
                const element = document.getElementById(btn);
                if (btn === `remaining-${type}`) {
                    element.className = 'py-2 px-3 border border-primary bg-primary text-white rounded-lg text-xs';
                } else {
                    element.className = 'py-2 px-3 border border-gray-300 rounded-lg text-xs';
                }
            });
        }

        function generateBill() {
            alert('Bill generated successfully!');
        }

        function calculateDiscount() {
            calculateTotals();
        }

        // Edit item functions
        function editItem(index) {
            editingItemIndex = index;
            const item = cartItems[index];
            
            // Populate modal fields
            document.getElementById('edit-item-name').value = item.name;
            document.getElementById('edit-item-quantity').value = item.quantity;
            document.getElementById('edit-item-unit').value = item.unit;
            document.getElementById('edit-item-price').value = item.price;
            
            // Convert dates to YYYY-MM-DD format for date inputs
            if (item.mfgDate) {
                const mfgParts = item.mfgDate.split('/');
                if (mfgParts.length === 3) {
                    document.getElementById('edit-item-mfg').value = `${mfgParts[2]}-${mfgParts[1].padStart(2, '0')}-${mfgParts[0].padStart(2, '0')}`;
                }
            }
            if (item.expDate) {
                const expParts = item.expDate.split('/');
                if (expParts.length === 3) {
                    document.getElementById('edit-item-exp').value = `${expParts[2]}-${expParts[1].padStart(2, '0')}-${expParts[0].padStart(2, '0')}`;
                }
            }
            
            // Show modal
            document.getElementById('edit-modal').classList.remove('hidden');
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.add('hidden');
            editingItemIndex = -1;
        }

        function saveEditedItem() {
            if (editingItemIndex === -1) return;
            
            const item = cartItems[editingItemIndex];
            
            // Update item properties
            item.quantity = parseFloat(document.getElementById('edit-item-quantity').value) || item.quantity;
            item.unit = document.getElementById('edit-item-unit').value || item.unit;
            item.price = parseFloat(document.getElementById('edit-item-price').value) || item.price;
            
            // Update dates if provided
            const mfgDate = document.getElementById('edit-item-mfg').value;
            const expDate = document.getElementById('edit-item-exp').value;
            
            if (mfgDate) {
                const mfgFormatted = new Date(mfgDate);
                item.mfgDate = `${mfgFormatted.getDate().toString().padStart(2, '0')}/${(mfgFormatted.getMonth() + 1).toString().padStart(2, '0')}/${mfgFormatted.getFullYear()}`;
                item.showDates = true;
            }
            
            if (expDate) {
                const expFormatted = new Date(expDate);
                item.expDate = `${expFormatted.getDate().toString().padStart(2, '0')}/${(expFormatted.getMonth() + 1).toString().padStart(2, '0')}/${expFormatted.getFullYear()}`;
                item.showDates = true;
            }
            
            // If both dates are provided, show dates
            if (mfgDate && expDate) {
                item.showDates = true;
            }
            
            // Save and re-render
            saveCart();
            renderCart();
            closeEditModal();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadCart();
            checkNewItems();
            renderCart();
            
            // Check for new items periodically
            setInterval(() => {
                checkNewItems();
            }, 2000);
        });

        // Search functionality (same as inventory)
        function openSearch() {
            const modal = document.getElementById('search-modal');
            const input = document.getElementById('search-input');
            
            modal.classList.remove('hidden');
            input.focus();
            document.body.style.overflow = 'hidden';
            
            input.addEventListener('input', performSearch);
        }

        function closeSearch() {
            const modal = document.getElementById('search-modal');
            const input = document.getElementById('search-input');
            
            modal.classList.add('hidden');
            input.value = '';
            document.getElementById('search-results').innerHTML = '';
            document.getElementById('search-empty').classList.add('hidden');
            document.body.style.overflow = 'auto';
            
            input.removeEventListener('input', performSearch);
        }

        function clearSearch() {
            document.getElementById('search-input').value = '';
            document.getElementById('search-results').innerHTML = '';
            document.getElementById('search-empty').classList.add('hidden');
        }

        function performSearch() {
            const query = document.getElementById('search-input').value.trim();
            const resultsContainer = document.getElementById('search-results');
            const emptyState = document.getElementById('search-empty');
            
            if (query.length < 2) {
                resultsContainer.innerHTML = '';
                emptyState.classList.add('hidden');
                return;
            }
            
            fetch(`/api/search-customers?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.customers && data.customers.length > 0) {
                        emptyState.classList.add('hidden');
                        resultsContainer.innerHTML = data.customers.map(customer => `
                            <div class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer" onclick="selectCustomerFromSearch(${customer.id})">
                                <div class="w-12 h-12 rounded-lg bg-gray-200 flex items-center justify-center mr-3">
                                    <i class="fa-solid fa-user text-gray-500"></i>
                                </div>
                                <div class="flex-1">
                                    <h3 class="font-semibold text-dark text-sm">${customer.name}</h3>
                                    <p class="text-xs text-gray-600">${customer.phone}</p>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold text-primary text-sm">₹${Math.abs(customer.outstanding_balance)}</p>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        resultsContainer.innerHTML = '';
                        emptyState.classList.remove('hidden');
                    }
                })
                .catch(error => {
                    console.error('Search error:', error);
                    resultsContainer.innerHTML = '<p class="text-red-500 text-center py-4">Search failed</p>';
                });
        }

        function selectCustomerFromSearch(customerId) {
            closeSearch();
            // Set the customer for billing
            fetch(`/api/customer/${customerId}`)
                .then(response => response.json())
                .then(customer => {
                    selectCustomer(customer.name);
                });
        }

        function createNewCustomer() {
            closeSearch();
            showNewCustomerTab();
        }
    </script>

    <!-- Search Modal -->
    <div id="search-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="fixed inset-0 flex flex-col">
            <div class="bg-white p-4">
                <div class="flex items-center space-x-3">
                    <button onclick="closeSearch()" class="p-2 hover:bg-gray-100 rounded-lg">
                        <i class="fa-solid fa-arrow-left text-gray-600"></i>
                    </button>
                    <div class="flex-1 relative">
                        <input type="text" id="search-input" placeholder="Search customers by name or phone..." class="w-full px-4 py-3 border border-gray-300 rounded-lg text-sm">
                        <button onclick="clearSearch()" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                            <i class="fa-solid fa-times"></i>
                        </button>
                    </div>
                    <button onclick="createNewCustomer()" class="p-2 bg-primary text-white rounded-lg hover:bg-primary-dark">
                        <i class="fa-solid fa-user-plus"></i>
                    </button>
                </div>
            </div>
            <div class="flex-1 bg-white px-4 pb-4 overflow-y-auto">
                <div id="search-results" class="space-y-3">
                    <!-- Search results will appear here -->
                </div>
                <div id="search-empty" class="text-center py-12 hidden">
                    <i class="fa-solid fa-search text-gray-300 text-4xl mb-4"></i>
                    <p class="text-gray-500">No customers found</p>
                    <button onclick="createNewCustomer()" class="mt-4 bg-primary text-white px-4 py-2 rounded-lg text-sm">
                        Add New Customer
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>